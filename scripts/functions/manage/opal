#!/usr/bin/env bash

opal_install()
{
  rvm_log "Running Opal prereqs checking script."

  type node && type npm > /dev/null
  result=$?

  if (( result > 0 ))
  then
    rvm_error "Prerequisite checks have failed. \nHalting the installation."
    exit $result
  fi

  builtin cd "${rvm_src_path}"

  system="$(uname -s)"
  arch="$(uname -m)"
  [ "${system}-${arch}" == "Darwin-x86_64" ] && arch="i386"

  rvm_log "Installing opal-node..."

  type opal-node || npm install opal --global > /dev/null
  result=$?

  if (( result > 0 ))
  then
    rvm_error "There has been an error while trying to install opal-node from npm registry."
    exit $result
  fi

  __rvm_rm_rf $rvm_ruby_home

  __rvm_run "install" \
    "mkdir -p ${rvm_ruby_home}/bin/" \
    "Installing opal to $rvm_ruby_home"

  opal_config=""
  opal_node_path="$(which opal-node)"

  opal_fake_gem_command='#!/usr/bin/env bash
  echo $@
  '

  ruby_wrapper=$(cat <<BASH
#!/usr/bin/env bash

export GEM_HOME="\${GEM_HOME:-$rvm_ruby_gem_home}"
export GEM_PATH="\${GEM_PATH:-$rvm_ruby_gem_path}"
export MY_RUBY_HOME="$rvm_ruby_home"
export PATH="$rvm_ruby_gem_home/bin:$rvm_ruby_global_gems_path/bin:$rvm_ruby_home/bin:\$PATH"
export NODE_PATH="$NODE_PATH:"
#$rvm_ruby_gem_home/bin:$rvm_ruby_global_gems_path/bin:$rvm_ruby_home/bin:\$PATH"

exec "$opal_node_path" "\$@"
BASH
  )

  (

  builtin cd "$rvm_ruby_home/bin/"
  # ln -fs "$opal_node_path" "ruby"
  echo "$ruby_wrapper" > "ruby"
  echo "$opal_fake_gem_command" > "gem"
  echo "$opal_config" > "config"
  chmod +x ruby gem config
  )

  __rvm_bin_script

  rvm_create_flag=1 __rvm_use
}
