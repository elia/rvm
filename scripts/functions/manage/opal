#!/usr/bin/env bash

opal_install()
{
  rvm_log "Running Opal prereqs checking script."
  rvm_log "Ensuring node and npm are present..."

  type node && type npm
  result=$?

  if (( result > 0 ))
  then
    rvm_error "Prerequisite checks have failed. \nHalting the installation."
    exit $result
  fi

  builtin cd "${rvm_src_path}"

  system="$(uname -s)"
  arch="$(uname -m)"
  [ "${system}-${arch}" == "Darwin-x86_64" ] && arch="i386"

  rvm_log "Installing opal-node..."

  npm install opal --global
  result=$?

  if (( result > 0 ))
  then
    rvm_error "There has been an error while trying to install opal-node from npm registry."
    exit $result
  fi

  __rvm_rm_rf $rvm_ruby_home



  __rvm_run "install" \
    "mkdir -p ${rvm_ruby_home}/bin/" \
    "Installing maglev to $rvm_ruby_home"
  (
  builtin cd "$rvm_ruby_home/bin/"
  ln -fs "$(which opal-node)" "ruby"
  )








  __rvm_bin_script

  rvm_create_flag=1 __rvm_use
}
